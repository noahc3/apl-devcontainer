# APL Development Container

This Docker setup creates a persistent development environment for Affinity Plugin Loader with MinGW, .NET SDK and necessary Windows SDK components (from Wine) pre-configured.

## Quick Start

### Initial Setup

First, generate the `.env` file with your user ID for proper file ownership:

```bash
# Run this once to create .env with your UID/GID
./setup-env.sh
```

This ensures files created inside the container are owned by your user, not root.

### Build and Start the Container

```bash
# Build the image and start the container in the background
docker-compose up -d --build
```

### Access the Container Shell

For an interactive bash shell:

```bash
# Option 1: Use the helper script
./shell.sh

# Option 2: Direct docker exec
docker exec -it apl-dev-environment bash
```

### Run One-Off Commands

```bash
# Use exec.sh to run commands inside the container
./exec.sh <command> [args...]

# Examples:
./exec.sh dotnet --version
./exec.sh ls -la ./
./exec.sh ./AffinityPluginLoader/build.sh

# The script automatically maps your current working directory to the container
# So if you're in ~/repos/AffinityPluginLoader, commands run in /home/host/repos/AffinityPluginLoader
cd ~/repos/AffinityPluginLoader
~/path/to/exec.sh dotnet build  # Runs in the mapped directory inside container
```

### Creating Wrapper Scripts

You can create wrapper scripts to use container tools as if they were installed on your host:

```bash
# Example: Create a wrapper for dotnet
echo '#!/usr/bin/env bash
/path/to/apl-dev-container/exec.sh dotnet "$@"' > ~/bin/dotnet-wine
chmod +x ~/bin/dotnet-wine

# Now you can use it from anywhere:
cd ~/repos/AffinityPluginLoader
dotnet-wine build
dotnet-wine run
```

This approach lets you seamlessly use the containerized build tools on AffinityPluginLoader or any other repository in your home directory.

### Stop the Container

```bash
# Stop the container (keeps volumes)
docker-compose down

# Stop and remove volumes (clean slate)
docker-compose down -v
```

## What's Included

The container includes everything needed to build Affinity Plugin Loader:
- Ubuntu 24.04 base
- Build tools (gcc, g++, make, etc.)
- MinGW-w64 cross-compiler
- .NET SDK 8.0
- Wine runtime (ElementalWarriorWine-7.9-amd64-wow64)
  - No prefix is configured, we just pull the runner for metahost.h and mscoree.dll
- [gin](https://github.com/noahc3/gin) (A simple Wine wrapper optimized for wrapper scripts, launchers and CI)

## Directory Structure

- `/home/ubuntu` - Container user's home directory (default working directory)
- `/gin` - Wine runner and prefix manager
- `/home/host` - Mount point for your entire home directory
- `/host` - Mount point for the apl-dev-container directory

## Volumes

The setup uses Docker volumes to persist data:
- `gin-data` - Persists Wine runners and prefixes

Host filesystem mounts:
- Your entire home directory is mounted at `/home/host` for accessing all repositories
- The apl-dev-container directory is mounted at `/host` for easy access

Clone AffinityPluginLoader (or any other project) in your home directory on the host, and you can build it directly using the containerized tools!

## Terminal Features

The container is configured with:
- Full TTY support (`tty: true`)
- Interactive stdin (`stdin_open: true`)
- Proper keycode passthrough via `docker exec -it`

This means you get a fully-featured bash shell with:
- Tab completion
- Arrow key navigation
- Ctrl+C/Ctrl+D support
- Full terminal colors and formatting

## Rebuild from Scratch

```bash
# Stop and remove everything
docker-compose down -v

# Rebuild
docker-compose up -d --build
```

## File Ownership

The container runs as a non-root user (`ubuntu`) with the same UID/GID as your host user. This means:

- Files created inside the container are owned by your user on the host
- No permission issues when accessing build outputs
- Safe to edit files from both inside and outside the container

The user mapping is configured via the `.env` file (generated by `./setup-env.sh`):
```bash
USER_UID=1000  # Your user ID
USER_GID=1000  # Your group ID
```

If you need to run commands as root inside the container, use `sudo`:
```bash
./exec.sh sudo apt update
```

## Notes

- The container runs `tail -f /dev/null` to stay alive in the background
- Use `docker-compose logs -f apl-dev` to view container logs
- The image contains copyrighted files and should only be used locally. Do not distribute the built container image.
- Run `./setup-env.sh` before first build to set up proper user ID mapping
